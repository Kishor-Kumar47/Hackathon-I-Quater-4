# Data Model: Retrieval Pipeline Testing and Validation System

**Feature**: 006-retrieval-validation
**Created**: 2025-12-23
**Related Plan**: specs/006-retrieval-validation/plan.md

## Entity: QueryRequest

### Description
Represents a search query with parameters for retrieval. This entity captures the user's search intent and configuration for the retrieval process.

### Fields
- **query_text** (string, required)
  - The search query text to be embedded and searched
  - Input from the user for content retrieval
- **top_k** (integer, optional)
  - Number of top results to return
  - Default: 5, Range: 1-100
- **similarity_threshold** (float, optional)
  - Minimum similarity score for results
  - Default: 0.5, Range: 0.0-1.0
- **query_embedding** (array of floats, optional)
  - The vector embedding of the query text
  - Generated by Cohere embedding model
- **created_at** (datetime, required)
  - Timestamp when the query was created
  - ISO 8601 format

### Validation Rules
- Query text must be non-empty
- Top_k must be between 1 and 100
- Similarity threshold must be between 0.0 and 1.0
- Query embedding must have consistent dimensions with stored vectors

### Relationships
- Zero-to-many with RetrievedChunk (queries may retrieve multiple chunks)
- Belongs to ValidationResult (for validation tests)

## Entity: RetrievedChunk

### Description
Represents a content chunk returned from the vector database with similarity score and metadata. This is the primary output of the retrieval process.

### Fields
- **chunk_id** (string, required)
  - Unique identifier for the chunk in Qdrant
  - Usually matches the vector ID in Qdrant
- **text** (string, required)
  - The retrieved content chunk text
  - Original content from the source document
- **score** (float, required)
  - Similarity score between query and retrieved content
  - Range: 0.0-1.0, where 1.0 is most similar
- **source_url** (string, required)
  - URL where the content originated
  - Full URL of the source document
- **metadata** (object, optional)
  - Additional metadata associated with the content chunk
  - May include title, headings, creation date, etc.
- **created_at** (datetime, required)
  - When the chunk was originally indexed
  - ISO 8601 format

### Validation Rules
- Text must be non-empty
- Score must be between 0.0 and 1.0
- Source URL must be a valid URL format
- Chunk ID must be a valid Qdrant vector ID

### Relationships
- Belongs to QueryRequest (result of a specific query)
- Belongs to ValidationResult (part of validation results)

## Entity: ValidationResult

### Description
Captures the outcome of pipeline validation tests with status, metrics, and diagnostic information. This entity tracks the success or failure of validation tests.

### Fields
- **test_id** (string, required)
  - Unique identifier for the validation test
  - Generated as UUID
- **status** (string, required)
  - Current status: "pass", "fail", "error"
- **query** (string, required)
  - The query that was tested
  - Original query text for the validation
- **expected_results** (array of strings, optional)
  - Expected content or topics that should be returned
  - Used for accuracy validation
- **actual_results** (array of RetrievedChunk, optional)
  - Actual results returned by the system
  - Array of retrieved content chunks
- **accuracy_score** (float, optional)
  - Calculated accuracy score for the test
  - Range: 0.0-1.0
- **latency_ms** (float, required)
  - Time taken to execute the query in milliseconds
- **error_message** (string, optional)
  - Error details if status is "error"
- **timestamp** (datetime, required)
  - When the validation was performed
  - ISO 8601 format

### Validation Rules
- Status must be one of: "pass", "fail", "error"
- Accuracy score must be between 0.0 and 1.0 if provided
- Latency must be positive
- Test ID must be unique

### Relationships
- One-to-many with RetrievedChunk (validation includes multiple results)
- One-to-many with QueryRequest (validation may test multiple queries)

## Entity: AccuracyMetric

### Description
Represents measurement of retrieval system performance with precision, recall, and relevance scores. This entity tracks the overall performance of the retrieval system.

### Fields
- **metric_id** (string, required)
  - Unique identifier for the metric set
  - Generated as UUID
- **precision** (float, optional)
  - Precision score for the retrieval
  - Range: 0.0-1.0
- **recall** (float, optional)
  - Recall score for the retrieval
  - Range: 0.0-1.0
- **relevance_score** (float, optional)
  - Overall relevance score
  - Range: 0.0-1.0
- **total_queries** (integer, required)
  - Total number of queries tested
- **relevant_queries** (integer, required)
  - Number of queries that returned relevant results
- **top_k_used** (integer, optional)
  - Top-k value used for the metrics
- **similarity_threshold** (float, optional)
  - Similarity threshold used for the metrics
- **timestamp** (datetime, required)
  - When the metrics were calculated
  - ISO 8601 format

### Validation Rules
- Precision, recall, and relevance_score must be between 0.0 and 1.0 if provided
- Total queries must be greater than or equal to relevant queries
- Top-k must be positive if provided
- Similarity threshold must be between 0.0 and 1.0 if provided

### Relationships
- One-to-many with ValidationResult (metrics computed from validation results)

## Entity: TestQuery

### Description
Represents a test query used for validation with expected outcomes. This entity defines the test cases for the validation system.

### Fields
- **test_query_id** (string, required)
  - Unique identifier for the test query
  - Generated as UUID
- **query_text** (string, required)
  - The test query text
  - Query to be executed during validation
- **expected_topics** (array of strings, required)
  - Expected topics or content that should be returned
  - Used to validate relevance of results
- **category** (string, optional)
  - Category or domain of the test query
  - e.g., "technical", "conceptual", "procedural"
- **difficulty** (string, optional)
  - Difficulty level: "easy", "medium", "hard"
- **created_at** (datetime, required)
  - When the test query was created
  - ISO 8601 format

### Validation Rules
- Query text must be non-empty
- Expected topics array must not be empty
- Difficulty must be one of: "easy", "medium", "hard" if provided

### Relationships
- One-to-many with ValidationResult (each test query produces validation results)

## Entity: RetrievalSession

### Description
Tracks a session of retrieval operations, grouping related queries and results for analysis.

### Fields
- **session_id** (string, required)
  - Unique identifier for the session
  - Generated as UUID
- **start_time** (datetime, required)
  - When the session started
  - ISO 8601 format
- **end_time** (datetime, optional)
  - When the session ended
  - ISO 8601 format
- **total_queries** (integer, required)
  - Total number of queries in the session
- **successful_queries** (integer, required)
  - Number of successful queries in the session
- **average_latency** (float, optional)
  - Average query latency in milliseconds
- **status** (string, required)
  - Current status: "active", "completed", "failed"
- **session_type** (string, required)
  - Type of session: "validation", "testing", "benchmarking"

### Validation Rules
- Status must be one of: "active", "completed", "failed"
- Session type must be one of: "validation", "testing", "benchmarking"
- Total queries must be greater than or equal to successful queries
- Average latency must be positive if provided

### Relationships
- One-to-many with QueryRequest (session contains multiple queries)
- One-to-many with ValidationResult (session contains multiple validation results)

## State Transitions

### ValidationResult Status Transitions
```
pending → pass
pending → fail
pending → error
```

- Once a validation result has a status, it is final
- Error status indicates system-level issues
- Fail status indicates validation criteria not met

### RetrievalSession Status Transitions
```
active → completed
active → failed
```

- Sessions start as active and transition to final states
- Completed indicates successful completion of all queries
- Failed indicates one or more queries failed

## Indexes and Performance Considerations

### QueryRequest
- Index on created_at for chronological queries
- Index on query_text for search analytics (if needed)

### RetrievedChunk
- Index on chunk_id for quick lookup
- Index on score for relevance ranking
- Index on source_url for source-based queries

### ValidationResult
- Index on test_id for unique identification
- Index on status for filtering validation results
- Index on timestamp for chronological analysis

### AccuracyMetric
- Index on timestamp for time-based analysis
- Index on metric_id for unique identification

### RetrievalSession
- Index on session_id for unique identification
- Index on status for session state queries
- Index on start_time for chronological analysis